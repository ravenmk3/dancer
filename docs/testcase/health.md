# 健康检查测试用例

## 测试概述

测试 Dancer DNS 系统的健康检查功能，验证系统状态监控和 etcd 连接状态检测。

---

## 测试用例清单

### TC-HEALTH-001: GET 方式健康检查 - 所有服务正常

**测试模块**: 健康检查模块  
**测试场景**: 使用 GET 请求检查健康状态，所有组件正常  
**优先级**: P0 (高)  
**测试类型**: 正向测试

**前置条件**:
- 系统已启动并运行
- etcd 服务正常运行且可连接
- 网络连接正常

**测试步骤**:
1. 发送 GET 请求到 `/api/health`
2. 不携带任何认证信息

**输入数据**: 无

**预期结果**:
- HTTP 状态码: 200
- 响应 JSON:
```json
{
  "status": "up",
  "components": {
    "etcd": "up"
  }
}
```
- 响应时间应小于 1 秒

---

### TC-HEALTH-002: POST 方式健康检查 - 所有服务正常

**测试模块**: 健康检查模块  
**测试场景**: 使用 POST 请求检查健康状态，所有组件正常  
**优先级**: P0 (高)  
**测试类型**: 正向测试

**前置条件**:
- 系统已启动并运行
- etcd 服务正常运行且可连接

**测试步骤**:
1. 发送 POST 请求到 `/api/health`
2. 不携带任何认证信息

**输入数据**: 无（或空 JSON 对象 `{}`）

**预期结果**:
- HTTP 状态码: 200
- 响应 JSON:
```json
{
  "status": "up",
  "components": {
    "etcd": "up"
  }
}
```
- 与 GET 请求返回相同的结果

---

### TC-HEALTH-003: 健康检查不需要认证

**测试模块**: 健康检查模块  
**测试场景**: 验证健康检查端点公开访问，不需要 JWT Token  
**优先级**: P0 (高)  
**测试类型**: 安全测试

**前置条件**:
- 系统已启动并运行
- etcd 服务正常

**测试步骤**:
1. 发送 GET 请求到 `/api/health`
2. 不携带 Authorization Header
3. 发送 GET 请求到 `/api/health`
4. 携带无效的 Authorization Header

**输入数据**:
```http
// 请求 2
Authorization: Bearer invalid.token.here
```

**预期结果**:
- 两次请求都应返回 200
- 健康检查端点应忽略认证信息
- 响应体显示 "status": "up"

---

### TC-HEALTH-004: etcd 服务不可用

**测试模块**: 健康检查模块  
**测试场景**: etcd 服务停止或无法连接时检查健康状态  
**优先级**: P0 (高)  
**测试类型**: 负向测试

**前置条件**:
- 系统已启动
- etcd 服务当前正常运行

**测试步骤**:
1. 先验证健康检查返回 200（etcd up）
2. 停止 etcd 服务
3. 等待 5 秒
4. 再次发送健康检查请求
5. 重新启动 etcd 服务

**输入数据**: 无

**预期结果**:
- 步骤 1: HTTP 200, etcd: "up"
- 步骤 4: 
  - HTTP 状态码: 503
  - 响应 JSON:
```json
{
  "status": "down",
  "components": {
    "etcd": "down"
  }
}
```
- 步骤 5 后: 健康检查应恢复 200

---

### TC-HEALTH-005: etcd 网络连接超时

**测试模块**: 健康检查模块  
**测试场景**: etcd 网络延迟或超时  
**优先级**: P1 (高)  
**测试类型**: 负向测试

**前置条件**:
- 系统已启动
- 可以模拟 etcd 网络延迟（如使用网络模拟工具）

**测试步骤**:
1. 模拟 etcd 网络延迟（如 10 秒延迟）
2. 发送健康检查请求

**输入数据**: 无

**预期结果**:
- HTTP 状态码: 503 或 504（超时）
- 响应 JSON:
```json
{
  "status": "down",
  "components": {
    "etcd": "down"
  }
}
```
- 健康检查应在合理时间内返回（如 5 秒内），不应无限等待

---

### TC-HEALTH-006: etcd 部分可用（集群场景）

**测试模块**: 健康检查模块  
**测试场景**: etcd 集群中部分节点不可用  
**优先级**: P2 (中)  
**测试类型**: 功能测试

**前置条件**:
- 系统已启动
- etcd 以集群模式运行（3 个节点）
- 系统配置连接到 etcd 集群

**测试步骤**:
1. 验证健康检查返回 200（所有节点正常）
2. 停止 1 个 etcd 节点
3. 发送健康检查请求
4. 停止第 2 个 etcd 节点（只剩 1 个）
5. 发送健康检查请求

**输入数据**: 无

**预期结果**:
- 步骤 1: HTTP 200, etcd: "up"
- 步骤 3: 
  - 如果系统能切换到可用节点：HTTP 200, etcd: "up"
  - 如果系统只连接一个节点且该节点仍可用：HTTP 200
  - 响应可能显示集群状态信息
- 步骤 5: 取决于剩余节点是否能提供读写服务
  - 如果可以：HTTP 200
  - 如果不可以：HTTP 503

---

### TC-HEALTH-007: 健康检查响应时间测试

**测试模块**: 健康检查模块  
**测试场景**: 验证健康检查响应时间在可接受范围内  
**优先级**: P1 (高)  
**测试类型**: 性能测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 发送 100 次健康检查请求
2. 记录每次响应时间
3. 计算平均响应时间和最大响应时间

**输入数据**: 无

**预期结果**:
- 平均响应时间 < 100ms
- 最大响应时间 < 500ms
- 99% 的请求响应时间 < 200ms
- 无请求超时或失败

---

### TC-HEALTH-008: 并发健康检查请求

**测试模块**: 健康检查模块  
**测试场景**: 并发大量健康检查请求  
**优先级**: P2 (中)  
**测试类型**: 性能测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 同时发送 100 个健康检查请求
2. 检查所有响应

**输入数据**: 无

**预期结果**:
- 所有请求都应返回 200
- 响应时间不应显著增加
- 系统不应出现性能下降或连接池耗尽
- 所有响应结果一致

---

### TC-HEALTH-009: 健康检查 JSON 格式验证

**测试模块**: 健康检查模块  
**测试场景**: 验证响应 JSON 格式符合规范  
**优先级**: P1 (高)  
**测试类型**: 功能测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 发送 GET 请求到 `/api/health`
2. 解析响应 JSON

**输入数据**: 无

**预期结果**:
- HTTP 状态码: 200
- Content-Type: application/json
- JSON 结构：
  - 根对象包含 `status` 字段（字符串，值为 "up" 或 "down"）
  - 根对象包含 `components` 对象
  - `components` 包含 `etcd` 字段（字符串，值为 "up" 或 "down"）
- 无其他额外字段或缺失字段

---

### TC-HEALTH-010: 健康检查包含额外信息（如支持）

**测试模块**: 健康检查模块  
**测试场景**: 验证健康检查是否返回额外有用信息  
**优先级**: P2 (中)  
**测试类型**: 功能测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 发送健康检查请求
2. 检查响应中是否包含额外信息

**输入数据**: 无

**预期结果**:
- 如果设计包含额外信息：
  - 可能包含：版本号、启动时间、运行时长、内存使用等
  - 这些信息应准确且有用
- 如果设计不包含：
  - 只返回基本状态信息

---

### TC-HEALTH-011: 服务刚启动时的健康检查

**测试模块**: 健康检查模块  
**测试场景**: 服务刚启动时立即检查健康状态  
**优先级**: P1 (高)  
**测试类型**: 功能测试

**前置条件**:
- 系统已停止

**测试步骤**:
1. 启动 Dancer 服务
2. 立即（< 1 秒）发送健康检查请求
3. 等待 5 秒
4. 再次发送健康检查请求

**输入数据**: 无

**预期结果**:
- 步骤 2: 
  - 如果服务需要初始化时间：可能返回 503 或连接失败
  - 如果服务启动快速：返回 200
- 步骤 4: 应返回 200（服务已完全启动）
- 服务应在合理时间内（如 10 秒）变得可用

---

### TC-HEALTH-012: 服务正在关闭时的健康检查

**测试模块**: 健康检查模块  
**测试场景**: 服务正在关闭过程中检查健康状态  
**优先级**: P2 (中)  
**测试类型**: 功能测试

**前置条件**:
- 系统已启动并运行
- etcd 服务正常

**测试步骤**:
1. 发送健康检查请求确认服务正常
2. 向服务发送关闭信号（如 SIGTERM）
3. 在关闭过程中立即发送健康检查请求
4. 等待服务完全关闭

**输入数据**: 无

**预期结果**:
- 步骤 1: HTTP 200
- 步骤 3: 
  - 可能返回 503（服务正在关闭）
  - 或返回 200（如果服务仍处理请求）
  - 不应返回 500 或 panic
- 步骤 4: 连接失败（服务已停止）

---

### TC-HEALTH-013: 健康检查端点不存在

**测试模块**: 健康检查模块  
**测试场景**: 访问错误路径的健康检查  
**优先级**: P2 (中)  
**测试类型**: 负向测试

**前置条件**:
- 系统已启动

**测试步骤**:
1. 发送 GET 请求到 `/health`（缺少 /api 前缀）
2. 发送 GET 请求到 `/api/health/`（多余斜杠）
3. 发送 GET 请求到 `/api/health/extra`（多余路径）

**输入数据**: 无

**预期结果**:
- HTTP 状态码: 404
- 响应显示端点不存在
- 不应泄露系统内部信息

---

### TC-HEALTH-014: 错误的 HTTP 方法

**测试模块**: 健康检查模块  
**测试场景**: 使用不支持的 HTTP 方法访问健康检查  
**优先级**: P2 (中)  
**测试类型**: 负向测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 发送 PUT 请求到 `/api/health`
2. 发送 DELETE 请求到 `/api/health`
3. 发送 PATCH 请求到 `/api/health`

**输入数据**: 无

**预期结果**:
- HTTP 状态码: 405 (Method Not Allowed)
- 或返回 200（如果服务忽略方法类型）
- 需要确认 API 设计

---

### TC-HEALTH-015: 健康检查跨域请求（CORS）

**测试模块**: 健康检查模块  
**测试场景**: 从其他域名发起健康检查请求  
**优先级**: P2 (中)  
**测试类型**: 安全测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 从浏览器发起跨域健康检查请求
2. 或发送带 Origin Header 的请求：

**输入数据**:
```http
Origin: https://other-domain.com
```

**预期结果**:
- 如果启用了 CORS：
  - 返回适当的 CORS Headers
  - 浏览器可以正常访问
- 如果未启用 CORS：
  - 浏览器阻止请求（CORS 错误）
  - 但请求实际上到达服务器并返回 200

---

### TC-HEALTH-016: 健康检查与负载均衡器集成

**测试模块**: 健康检查模块  
**测试场景**: 模拟负载均衡器健康检查行为  
**优先级**: P2 (中)  
**测试类型**: 集成测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 配置负载均衡器使用 `/api/health` 作为健康检查端点
2. 验证负载均衡器能正确识别服务状态
3. 停止 etcd 服务
4. 验证负载均衡器将服务标记为不健康
5. 恢复 etcd 服务
6. 验证负载均衡器将服务标记为健康

**输入数据**: 无

**预期结果**:
- 负载均衡器能正确检测服务健康状态
- 服务不健康时从负载均衡池移除
- 服务恢复后重新加入负载均衡池
- 健康检查间隔和超时配置合理

---

### TC-HEALTH-017: etcd 认证失败

**测试模块**: 健康检查模块  
**测试场景**: etcd 配置了认证但凭证错误  
**优先级**: P2 (中)  
**测试类型**: 负向测试

**前置条件**:
- 系统已启动
- etcd 配置了认证（用户名/密码或 TLS）
- Dancer 配置了错误的 etcd 凭证

**测试步骤**:
1. 发送健康检查请求

**输入数据**: 无

**预期结果**:
- HTTP 状态码: 503
- 响应 JSON:
```json
{
  "status": "down",
  "components": {
    "etcd": "down"
  }
}
}
```
- 错误日志应记录认证失败详情（服务端）

---

### TC-HEALTH-018: etcd TLS 证书问题

**测试模块**: 健康检查模块  
**测试场景**: etcd 使用 TLS 但证书配置错误  
**优先级**: P2 (中)  
**测试类型**: 负向测试

**前置条件**:
- 系统已启动
- etcd 使用 TLS
- Dancer 配置错误的 TLS 证书或 CA

**测试步骤**:
1. 发送健康检查请求

**输入数据**: 无

**预期结果**:
- HTTP 状态码: 503
- 响应 JSON:
```json
{
  "status": "down",
  "components": {
    "etcd": "down"
  }
}
```
- 错误日志应记录 TLS 握手失败详情

---

### TC-HEALTH-019: 系统资源不足

**测试模块**: 健康检查模块  
**测试场景**: 系统内存或 CPU 严重不足时检查健康状态  
**优先级**: P2 (中)  
**测试类型**: 压力测试

**前置条件**:
- 系统已启动
- etcd 服务正常
- 可以模拟资源压力

**测试步骤**:
1. 给系统施加压力（如内存压力测试）
2. 发送健康检查请求

**输入数据**: 无

**预期结果**:
- 健康检查应尽可能返回 200（如果服务还能响应）
- 或返回 503（如果服务无法正常运行）
- 不应因资源问题导致服务崩溃

---

### TC-HEALTH-020: 健康检查 Header 验证

**测试模块**: 健康检查模块  
**测试场景**: 验证响应包含正确的 HTTP Headers  
**优先级**: P1 (高)  
**测试类型**: 功能测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 发送 GET 请求到 `/api/health`
2. 检查响应 Headers

**输入数据**: 无

**预期结果**:
- HTTP 状态码: 200
- Content-Type: application/json; charset=utf-8
- 可能包含：
  - Cache-Control: no-cache（防止缓存健康状态）
  - X-Content-Type-Options: nosniff
  - X-Frame-Options: DENY
  - 或其他安全 Headers

---

### TC-HEALTH-021: 健康检查日志记录

**测试模块**: 健康检查模块  
**测试场景**: 验证健康检查是否记录日志  
**优先级**: P2 (中)  
**测试类型**: 功能测试

**前置条件**:
- 系统已启动
- etcd 服务正常
- 日志系统正常工作

**测试步骤**:
1. 发送健康检查请求
2. 检查系统日志

**输入数据**: 无

**预期结果**:
- 健康检查请求应被记录（访问日志）
- 日志包含：请求时间、客户端 IP、端点、响应状态、响应时间
- 如果 etcd 不可用，应记录错误日志
- 日志级别适当（不应过度记录）

---

### TC-HEALTH-022: 长期运行的健康检查

**测试模块**: 健康检查模块  
**测试场景**: 长时间持续健康检查，检测连接泄漏  
**优先级**: P2 (中)  
**测试类型**: 稳定性测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 每 5 秒发送一次健康检查请求
2. 持续运行 1 小时
3. 监控响应时间和内存使用

**输入数据**: 无

**预期结果**:
- 所有请求返回 200
- 响应时间保持稳定
- 服务内存使用不持续增长（无连接泄漏）
- 无错误日志

---

### TC-HEALTH-023: 健康检查与业务功能并发

**测试模块**: 健康检查模块  
**测试场景**: 在执行其他业务操作时检查健康状态  
**优先级**: P2 (中)  
**测试类型**: 集成测试

**前置条件**:
- 系统已启动
- etcd 服务正常

**测试步骤**:
1. 并发执行大量业务操作（如创建多个 Domain）
2. 同时持续发送健康检查请求

**输入数据**: 业务操作请求

**预期结果**:
- 健康检查始终返回 200
- 响应时间可能略有增加但可接受
- 业务操作正常完成
- 系统整体稳定

---

### TC-HEALTH-024: 健康检查返回详细信息（扩展）

**测试模块**: 健康检查模块  
**测试场景**: 如果支持，检查详细健康信息端点  
**优先级**: P3 (低)  
**测试类型**: 功能测试

**前置条件**:
- 系统已启动
- etcd 服务正常
- 可能存在详细健康检查端点（如 `/api/health/details`）

**测试步骤**:
1. 尝试访问 `/api/health/details` 或类似端点
2. 或发送带查询参数的请求：`/api/health?verbose=true`

**输入数据**: 无

**预期结果**:
- 如果存在详细端点：
  - 返回更详细的健康信息
  - 如：etcd 版本、连接数、延迟统计、内存使用等
- 如果不存在：
  - 返回 404 或普通健康检查结果

---

### TC-HEALTH-025: 健康检查与监控系统集成

**测试模块**: 健康检查模块  
**测试场景**: 验证健康检查端点可被监控系统使用  
**优先级**: P2 (中)  
**测试类型**: 集成测试

**前置条件**:
- 系统已启动
- etcd 服务正常
- 监控系统（如 Prometheus）可访问

**测试步骤**:
1. 配置 Prometheus 监控 `/api/health` 端点
2. 检查 Prometheus 能正确获取健康状态
3. 停止 etcd 服务
4. 验证 Prometheus 检测到服务不健康
5. 恢复 etcd 服务
6. 验证 Prometheus 检测到服务恢复

**输入数据**: 无

**预期结果**:
- 监控系统能正确识别服务健康状态
- 健康状态变化能及时被检测到
- 监控数据可用于告警

---

## 测试数据准备

### 测试环境配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| Dancer 服务地址 | http://localhost:8080 | 服务监听地址 |
| 健康检查端点 | /api/health | 健康检查路径 |
| etcd 地址 | localhost:2379 | etcd 服务地址 |
| etcd 集群 | localhost:2379, localhost:22379, localhost:32379 | 集群模式测试时使用 |

### 健康检查工具

- curl: 基本 HTTP 请求测试
- Apache Bench (ab): 性能测试
- Postman: 手动测试和验证
- k6/JMeter: 负载测试
- etcdctl: 直接操作 etcd 模拟故障

---

## 依赖和前置条件

1. Dancer 服务已启动并监听 8080 端口
2. etcd 服务正常运行（单机或集群）
3. 网络连接正常
4. 有权限停止/启动 etcd 服务（用于故障测试）
5. 负载均衡器（如 Nginx）可用于集成测试（可选）
6. 监控系统（如 Prometheus）可用于集成测试（可选）

---

## 风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 健康检查自身不稳定 | 低 | 高 | 长期运行测试验证 |
| 连接泄漏 | 中 | 中 | 长时间测试监控内存 |
| etcd 检测不准确 | 低 | 高 | 多种故障场景测试 |
| 健康检查成为攻击目标 | 低 | 中 | 安全测试验证公开访问 |

---

## 测试通过标准

- 所有 P0 和 P1 测试用例通过
- 健康检查在 etcd 正常时返回 200，异常时返回 503
- 响应时间 < 100ms（平均）
- 无连接泄漏（长时间运行稳定）
- 能正确检测各种 etcd 故障场景
- 与负载均衡器和监控系统正确集成
- 公开访问但不泄露敏感信息
